<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ—¥æ›†å¤©æ°£æ¸¬è©¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; font-size: 20px; }
    #weatherInfo { margin-top: 20px; font-size: 22px; color: #333; }
  </style>
</head>
<body>
  <h2>ğŸ“… ä»Šæ—¥æ—¥æœŸ</h2>
  <div id="gregorian">è¼‰å…¥ä¸­...</div>
  <div id="lunar">è¼‰å…¥ä¸­...</div>

  <h2>ğŸŒ¤ å¤©æ°£é å ±</h2>
  <label for="city">é¸æ“‡ç¸£å¸‚ï¼š</label>
  <select id="city">
    <option value="è‡ºåŒ—å¸‚" selected>è‡ºåŒ—å¸‚</option>
    <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
    <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
    <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
    <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
  </select>
  <button onclick="fetchWeather()">æ›´æ–°å¤©æ°£</button>
  <div id="weatherInfo">è¼‰å…¥ä¸­...</div>

  <script src="https://cdn.jsdelivr.net/npm/solarlunar/solarlunar.min.js"></script>
  <script>
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    const weekday = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][today.getDay()];
    document.getElementById("gregorian").innerText = `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆæ˜ŸæœŸ${weekday}ï¼‰`;

    const lunar = solarlunar.solar2lunar(year, month, day);
    document.getElementById("lunar").innerText = `è¾²æ›† ${lunar.lMonth}æœˆ${lunar.lDayName} Â· ${lunar.animal}å¹´ ${lunar.term ? "ç¯€æ°£ï¼š" + lunar.term : ""}`;

    const API_KEY = "CWA-A6F3874E-27F3-4AA3-AF5A-96B365798F79";

    async function fetchWeather() {
      const city = document.getElementById("city").value;
      const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${API_KEY}&locationName=${city}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const location = data.records.location.find(loc => loc.locationName === city);
        if (!location) {
          document.getElementById("weatherInfo").innerText = `${city}ï¼šæ‰¾ä¸åˆ°å¤©æ°£è³‡æ–™`;
          return;
        }

        const now = new Date();
        function pickTime(elementName) {
          const element = location.weatherElement.find(e => e.elementName === elementName);
          if (!element) return "--";
          const match = element.time.find(t => {
            const start = new Date(t.startTime);
            const end = new Date(t.endTime);
            return now >= start && now < end;
          });
          return match?.parameter?.parameterName || element.time[0]?.parameter?.parameterName || "--";
        }

        const wx = pickTime("Wx");
        const minT = pickTime("MinT");
        const maxT = pickTime("MaxT");
        const pop = pickTime("PoP");
        const ci = pickTime("CI");

        document.getElementById("weatherInfo").innerText =
          `${city}ï¼š${wx} Â· ${minT}Â°C ~ ${maxT}Â°C Â· é™é›¨ ${pop}% Â· ${ci}`;
      } catch (err) {
        document.getElementById("weatherInfo").innerText = "å¤©æ°£è³‡æ–™è¼‰å…¥å¤±æ•—";
        console.error(err);
      }
    }

    fetchWeather();
    document.getElementById("city").addEventListener("change", fetchWeather);
  </script>
</body>
</html>
